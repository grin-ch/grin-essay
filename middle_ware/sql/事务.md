[TOC]

# 事务(Transaction)

## 四大特性(ACID)

### 原子性(atomic)

- 一个事务是不可再细分的单位
- 同一个事务中的所有操作要么全部成功,要么全部失败

### 一致性(consistency)

- 事务必须保证数据库是从一个一致性状态变成另一个一致性状态

### 隔离性(isolation)

- 事务与事务之间不会相互影响
- 并发的事务之间相互隔离

### 持久性(durability)

- 一个事务一旦被提交,其对数据库的影响是永久的
- 接下来即使数据库出现故障也不对其产生影响

# 隔离级别

## 面对的问题

- 脏读:事务读取到了另一个事务未提交(回滚)的数据
- 不可重复读:事务多次读取同一条数据,得到的结果不一致(其他事务再多次读取的间隙改变了这条数据)
- 幻读:事务前后读取的数据数量不一致(前后两次读取的间隙中,其他事务新增了符合查询条件的数据)

## 读未提交

- 允许读到未提交的数据
- 会导致脏读,不可重复读,幻读

## 读已提交

- 事务只能读取到其他事务已经提交的数据
- 避免了脏读
- SQL Server 和 Oracle的默认隔离级别

## 可重复读

- 事务启动时,将第一次查询到的数据加锁,其他事务不允许进行修改操作(行锁)
- 避免了脏读和不可重复读
- Mysql的默认隔离级别
- 导致幻读的原因是:不能阻止其他事务的insert操作

## 串行化

- 事务按照顺序一个一个执行(表锁)
- 避免了脏读,不可重复读,幻读
- 效率低下

| 隔离级别\问题 | 脏读  | 不可重复读 | 幻读  |
| ------- | --- | ----- | --- |
| 读未提交    | 会   | 会     | 会   |
| 读已提交    | 不会  | 会     | 会   |
| 可重复读    | 不会  | 不会    | 会   |
| 串行化     | 不会  | 不会    | 不会  |

# 锁

## 读锁(共享锁)

- 只许查询,不能修改
- 其他事务只许添加读锁,不能添加写锁

## 写锁(互斥锁)

- 可以查询和修改
- 其他事务不能加锁

## 表锁

- 一次对一张表加锁

## 行锁

- 一次对一条数据加锁

## 页级锁

- 介于表锁和行锁之间

## 乐观锁

- 数据库更新时,乐观的认为此事务不会冲突,不加锁,更新后再判断是否冲突

## 悲观锁

- 操作数据时,认为此事务会存在冲突,每次需要先获取锁才操作